{% extends "accounts/profile.html" %}
{% load static %}

{% block profile_content %}
{% csrf_token %}
<div class="settings-content">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if subsection == 'account' %}active{% endif %}" id="account-tab"
                data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                <i class="fas fa-user me-2"></i>Account
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if subsection == 'contact' %}active{% endif %}" id="contact-tab"
                data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                <i class="fas fa-address-card me-2"></i>Contact Information
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if subsection == 'payments' %}active{% endif %}" id="payments-tab"
                data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                <i class="fas fa-credit-card me-2"></i>Payments Option
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if subsection == 'messages' %}active{% endif %}" id="messages-tab"
                data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">
                <i class="fas fa-envelope me-2"></i>Messages
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if subsection == 'blacklist' %}active{% endif %}" id="blacklist-tab"
                data-bs-toggle="tab" data-bs-target="#blacklist" type="button" role="tab">
                <i class="fas fa-ban me-2"></i>BlackList
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- Account Tab -->
        <div class="tab-pane fade {% if subsection == 'account' %}show active{% endif %}" id="account" role="tabpanel">
            <section class="mb-5">
                <h2 class="section-title mb-4">Account Settings</h2>
                <div class="account-settings">
                    <!-- Name Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Your Name</label>
                                <div class="setting-value" id="nameDisplay">{{ user.name|default:"" }}</div>
                                <div class="edit-form d-none">
                                    <input type="text" class="form-control" id="nameInput"
                                        value="{{ user.name|default:"" }}" placeholder="Enter your name">
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-name">Save</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="name">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Avatar Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Avatar</label>
                                <div class="setting-value d-flex align-items-center">
                                    {% include "includes/user_avatar.html" %}
                                </div>
                                <div class="edit-form d-none">
                                    <input type="file" class="form-control" id="avatarInput" accept="image/*">
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-avatar">Upload</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="avatar">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Age Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Age</label>
                                <div class="setting-value" id="ageDisplay">{{ user.age|default:"Not specified" }}</div>
                                <div class="edit-form d-none">
                                    <input type="number" class="form-control" id="ageInput"
                                        value="{{ user.age|default:"" }}" min="13" max="120">
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-age">Save</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="age">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Gender Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Gender</label>
                                <div class="setting-value" id="genderDisplay">
                                    {{ user.gender|default:"Not specified" }}
                                </div>
                                <div class="edit-form d-none">
                                    <select class="form-select" id="genderSelect">
                                        <option value="">Prefer not to answer</option>
                                        <option value="male" {% if user.gender is 'male' %}selected{% endif %}>
                                            Male
                                        </option>
                                        <option value="female" {% if user.gender is 'female' %}selected{% endif %}>
                                            Female
                                        </option>
                                    </select>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-gender">Save</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="gender">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Account Type -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Account Type</label>
                                <div class="setting-value">Individual</div>
                                <p class="text-muted mb-0">Basic account features</p>
                            </div>
                            <button class="btn btn-primary">Upgrade</button>
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Password</label>
                                <div class="setting-value">••••••••</div>
                            </div>
                            <button class="btn btn-link edit-btn">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Delete Account -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Delete Account</label>
                                <p class="text-muted mb-0">This action cannot be undone</p>
                            </div>
                            <button class="btn btn-danger">Delete Account</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Contact Information Tab -->
        <div class="tab-pane fade {% if subsection == 'contact' %}show active{% endif %}" id="contact" role="tabpanel">
            <section class="mb-5">
                <h2 class="section-title mb-4">Contact Information</h2>
                <div class="settings-form">
                    <!-- Email Field (non-editable) -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Email</label>
                                <div class="setting-value">{{ user.email }}</div>
                                <small class="text-muted">Your email address cannot be changed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Phone Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">Phone</label>
                                <div class="setting-value" id="phoneDisplay">
                                    <span class="phone-number">{{ user.phone|default:"Not set" }}</span>
                                    {% if user.phone %}
                                    <span
                                        class="verification-status ms-2 {% if user.phone_verified %}text-success{% else %}text-danger{% endif %}">
                                        {% if user.phone_verified %}
                                        <i class="fas fa-check-circle"></i> Verified
                                        {% else %}
                                        <i class="fas fa-exclamation-circle"></i> Unverified
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="edit-form d-none">
                                    <input type="tel" class="form-control" id="phoneInput"
                                        value="{{ user.phone|default:" +1" }}" placeholder="+1 (XXX) XXX-XXXX">
                                    <small class="text-muted">Format: +1 (XXX) XXX-XXXX</small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-phone">Save</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                    <!-- Verification form (hidden by default) -->
                                    <div class="verification-form mt-3 d-none">
                                        <div class="alert alert-info">
                                            A verification code has been sent to your email.
                                            Please enter it below to verify your phone number.
                                        </div>
                                        <input type="text" class="form-control" id="verificationCode"
                                            placeholder="Enter verification code">
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-success verify-phone">Verify</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="phone">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ZIP Code Field -->
                    <div class="setting-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <label class="form-label">ZIP Code</label>
                                <div class="setting-value" id="zipCodeDisplay">
                                    {{ user.zip_code|default:"Not set" }}
                                </div>
                                <div class="edit-form d-none">
                                    <input type="text" class="form-control" id="zipCodeInput"
                                        value="{{ user.zip_code|default:"" }}" placeholder="12345 or 12345-6789">
                                    <small class="text-muted">Format: 12345 or 12345-6789</small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary save-zipcode">Save</button>
                                        <button class="btn btn-sm btn-link cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-link edit-btn" data-edit="zipcode">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Payments Option Tab -->
        <div class="tab-pane fade {% if subsection == 'payments' %}show active{% endif %}" id="payments"
            role="tabpanel">
            <section class="mb-5">
                <h2 class="section-title mb-4">Payment Methods</h2>
                <div class="payment-methods">
                    <p class="text-muted mb-4">Add and manage your payment methods</p>
                    <button class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Payment Method
                    </button>
                </div>
            </section>
        </div>

        <!-- Messages Tab -->
        <div class="tab-pane fade {% if subsection == 'messages' %}show active{% endif %}" id="messages"
            role="tabpanel">
            <section class="mb-5">
                <h2 class="section-title mb-4">Message Settings</h2>
                <div class="message-settings">
                    <div class="setting-item mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications">
                            <label class="form-check-label" for="emailNotifications">
                                Email Notifications
                            </label>
                        </div>
                    </div>
                    <div class="setting-item mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pushNotifications">
                            <label class="form-check-label" for="pushNotifications">
                                Push Notifications
                            </label>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- BlackList Tab -->
        <div class="tab-pane fade {% if subsection == 'blacklist' %}show active{% endif %}" id="blacklist"
            role="tabpanel">
            <section class="mb-5">
                <h2 class="section-title mb-4">Blocked Users</h2>
                <div class="blocked-users-list">
                    <p class="text-muted">You haven't blocked any users yet.</p>
                </div>
            </section>
        </div>
    </div>
</div>

<style>
    .nav-tabs {
        border-bottom: 1px solid rgba(12, 26, 50, 0.1);
    }

    .nav-tabs .nav-link {
        color: var(--text-color);
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 500;
        position: relative;
    }

    .nav-tabs .nav-link:hover {
        border: none;
        color: var(--button-bg);
    }

    .nav-tabs .nav-link.active {
        color: var(--button-bg);
        border: none;
        background: none;
    }

    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--button-bg);
    }

    .section-title {
        font-size: 1.25rem;
        margin-bottom: 0;
    }

    .setting-item {
        padding: 1rem 0;
        border-bottom: 1px solid rgba(12, 26, 50, 0.1);
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .form-label {
        color: rgba(12, 26, 50, 0.6);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .setting-value {
        color: var(--text-color);
        font-weight: 500;
    }

    .edit-btn {
        color: rgba(12, 26, 50, 0.6);
        padding: 0.5rem;
    }

    .edit-btn:hover {
        color: var(--button-bg);
    }

    .payment-methods,
    .message-settings,
    .blocked-users-list,
    .account-settings {
        background: rgba(12, 26, 50, 0.02);
        border-radius: var(--button-radius);
        padding: 2rem;
    }

    /* Form switch customization */
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        margin-top: 0.25em;
    }

    .form-switch .form-check-input:checked {
        background-color: var(--button-bg);
        border-color: var(--button-bg);
    }

    .edit-form {
        margin-top: 0.5rem;
        width: 100%;
        max-width: 300px;
    }

    .avatar-image {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
    }

    .octagon-user {
        width: 48px;
        height: 48px;
        background-color: var(--button-bg);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 500;
        border-radius: 50%;
    }

    .form-select {
        padding: 0.5rem;
        border-radius: var(--button-radius);
        border: 1px solid rgba(12, 26, 50, 0.1);
    }

    .form-control {
        padding: 0.5rem;
        border-radius: var(--button-radius);
        border: 1px solid rgba(12, 26, 50, 0.1);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--button-bg);
        box-shadow: 0 0 0 0.2rem rgba(15, 29, 53, 0.25);
    }
</style>

<!-- Add IMask.js library -->
<script src="https://unpkg.com/imask"></script>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAccountModalLabel">Delete Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Warning: This action cannot be undone. All your data will be permanently deleted.
                </div>
                <form id="deleteAccountForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="confirmEmail" class="form-label">Please enter your email to confirm account
                            deletion</label>
                        <input type="email" class="form-control" id="confirmEmail" required
                            placeholder="Enter your email address">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAccount">Delete Account</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Initialize phone input mask
        const phoneInput = document.getElementById('phoneInput');
        if (phoneInput) {
            const phoneMask = IMask(phoneInput, {
                mask: '+1 (000) 000-0000'
            });
        }

        // Handle edit button clicks
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function () {
                const field = this.dataset.edit;
                const container = this.closest('.setting-item');
                const displayEl = container.querySelector('.setting-value');
                const formEl = container.querySelector('.edit-form');

                displayEl.classList.add('d-none');
                formEl.classList.remove('d-none');
                this.classList.add('d-none');
            });
        });

        // Handle cancel buttons
        document.querySelectorAll('.cancel-edit').forEach(button => {
            button.addEventListener('click', function () {
                const container = this.closest('.setting-item');
                const displayEl = container.querySelector('.setting-value');
                const formEl = container.querySelector('.edit-form');
                const editBtn = container.querySelector('.edit-btn');

                displayEl.classList.remove('d-none');
                formEl.classList.add('d-none');
                editBtn.classList.remove('d-none');
            });
        });

        // Handle name save
        document.querySelector('.save-name')?.addEventListener('click', async function () {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();

            try {
                const response = await fetch('/accounts/profile/settings/update/name/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('nameDisplay').textContent = name || 'Not specified';
                    // Close edit form
                    const cancelBtn = document.querySelector('.save-name').closest('.setting-item').querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to update name');
                }
            } catch (error) {
                alert('Error updating name');
            }
        });

        // Handle age save
        document.querySelector('.save-age')?.addEventListener('click', async function () {
            const ageInput = document.getElementById('ageInput');
            const age = ageInput.value ? parseInt(ageInput.value) : null;

            try {
                const response = await fetch('/accounts/profile/settings/update/age/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ age })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('ageDisplay').textContent = age || 'Not specified';
                    // Close edit form
                    const cancelBtn = document.querySelector('.save-age').closest('.setting-item').querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to update age');
                }
            } catch (error) {
                alert('Error updating age');
            }
        });

        // Handle gender save
        document.querySelector('.save-gender')?.addEventListener('click', async function () {
            const genderSelect = document.getElementById('genderSelect');
            const gender = genderSelect.value;

            try {
                const response = await fetch('/accounts/profile/settings/update/gender/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ gender })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('genderDisplay').textContent = gender || 'Not specified';
                    // Close edit form
                    const cancelBtn = document.querySelector('.save-gender').closest('.setting-item').querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to update gender');
                }
            } catch (error) {
                alert('Error updating gender');
            }
        });

        // Handle avatar upload
        document.querySelector('.save-avatar')?.addEventListener('click', async function () {
            const avatarInput = document.getElementById('avatarInput');
            if (!avatarInput.files || !avatarInput.files[0]) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', avatarInput.files[0]);

            try {
                const response = await fetch('/accounts/profile/settings/update/avatar/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.status === 'success') {
                    // Update avatar display
                    const avatarContainer = document.querySelector('.setting-value.d-flex');
                    avatarContainer.innerHTML = `<img src="${data.avatar_url}" alt="User avatar" class="avatar-image me-3">`;
                    // Close edit form
                    const cancelBtn = document.querySelector('.save-avatar').closest('.setting-item').querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to update avatar');
                }
            } catch (error) {
                alert('Error updating avatar');
            }
        });

        // Handle phone save
        document.querySelector('.save-phone')?.addEventListener('click', async function () {
            const phoneInput = document.getElementById('phoneInput');
            const phone = phoneInput.value.trim();

            try {
                const response = await fetch('/accounts/profile/settings/update/phone/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ phone })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    // Update display
                    const phoneDisplay = document.querySelector('#phoneDisplay .phone-number');
                    phoneDisplay.textContent = phone || 'Not set';

                    // Update verification status
                    const verificationStatus = document.querySelector('#phoneDisplay .verification-status');
                    if (verificationStatus) {
                        verificationStatus.className = 'verification-status ms-2 ' +
                            (data.verified ? 'text-success' : 'text-danger');
                        verificationStatus.innerHTML = data.verified ?
                            '<i class="fas fa-check-circle"></i> Verified' :
                            '<i class="fas fa-exclamation-circle"></i> Unverified';
                    }

                    // Show verification form if needed
                    if (data.verification_needed) {
                        document.querySelector('.verification-form').classList.remove('d-none');
                    } else {
                        // Close edit form if no verification needed
                        const cancelBtn = document.querySelector('.save-phone')
                            .closest('.setting-item')
                            .querySelector('.cancel-edit');
                        cancelBtn.click();
                    }
                } else {
                    alert(data.message || 'Failed to update phone');
                }
            } catch (error) {
                alert('Error updating phone');
            }
        });

        // Handle phone verification
        document.querySelector('.verify-phone')?.addEventListener('click', async function () {
            const codeInput = document.getElementById('verificationCode');
            const code = codeInput.value.trim();

            try {
                const response = await fetch('/accounts/profile/settings/update/phone/verify/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    // Update verification status
                    const verificationStatus = document.querySelector('#phoneDisplay .verification-status');
                    verificationStatus.className = 'verification-status ms-2 text-success';
                    verificationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Verified';

                    // Close edit form
                    const cancelBtn = document.querySelector('.save-phone')
                        .closest('.setting-item')
                        .querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to verify phone');
                }
            } catch (error) {
                alert('Error verifying phone');
            }
        });

        // Handle ZIP code save
        document.querySelector('.save-zipcode')?.addEventListener('click', async function () {
            const zipCodeInput = document.getElementById('zipCodeInput');
            const zip_code = zipCodeInput.value.trim();

            try {
                const response = await fetch('/accounts/profile/settings/update/zipcode/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ zip_code })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('zipCodeDisplay').textContent = zip_code || 'Not set';
                    // Close edit form
                    const cancelBtn = document.querySelector('.save-zipcode')
                        .closest('.setting-item')
                        .querySelector('.cancel-edit');
                    cancelBtn.click();
                } else {
                    alert(data.message || 'Failed to update ZIP code');
                }
            } catch (error) {
                alert('Error updating ZIP code');
            }
        });

        // Delete Account functionality
        const deleteAccountBtn = document.querySelector('.btn-danger');
        const confirmDeleteBtn = document.getElementById('confirmDeleteAccount');
        const deleteAccountModal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
        const confirmEmailInput = document.getElementById('confirmEmail');

        deleteAccountBtn.addEventListener('click', function () {
            confirmEmailInput.value = ''; // Очищаем поле email
            deleteAccountModal.show();
        });

        confirmDeleteBtn.addEventListener('click', async function () {
            const email = confirmEmailInput.value.trim();

            if (email !== '{{ user.email }}') {
                alert('Email does not match your account email');
                return;
            }

            try {
                const response = await fetch('/accounts/profile/settings/delete-account/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    window.location.href = '/'; // Redirect to home page after successful deletion
                } else {
                    alert(data.message || 'Failed to delete account');
                }
            } catch (error) {
                alert('Error deleting account');
            }
        });
    });
</script>
{% endblock %}