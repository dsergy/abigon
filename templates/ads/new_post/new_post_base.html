{% extends "base.html" %}
{% load static %}

{% block title %}Create New {{ post_type|title }} - Abigon{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_main.css' %}">
<link rel="stylesheet" href="{% static 'css/post_home.css' %}">
{% endblock %}

{% block content %}
<div class="new-post-container">
    <!-- Left Sidebar Block -->
    <div class="new-post-sidebar" id="sidebar-content">
        {% include sidebar_template with active_page=active_page post_type=post_type %}
    </div>

    <!-- Right Content Block -->
    <div class="new-post-content">
        <!-- Progress Bar Block -->
        <div class="progress-section">
            {% include "ads/new_post/progress/progress_bar.html" with step=current_step %}
        </div>

        <!-- Post Content Block -->
        <div class="post-section" id="post-content">
            {% block post_content %}
            {% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // State management
    const state = {
        currentStep: parseInt('{{ current_step|default:1 }}'),
        postType: '{{ post_type }}',
        activePage: '{{ active_page }}'
    };

    // Initialize progress bar
    document.addEventListener('DOMContentLoaded', function () {
        const progress = new PostProgress(state.currentStep, 5);

        // Handle step changes
        document.addEventListener('stepChanged', function (e) {
            const { step, label } = e.detail;

            // Update state
            state.currentStep = step;

            // Update URL without page reload
            const url = new URL(window.location.href);
            url.searchParams.set('step', step);
            window.history.pushState({}, '', url);

            // Load content for the new step
            loadStepContent(step);
        });
    });

    // Function to load step content
    async function loadStepContent(step) {
        try {
            const response = await fetch(`/ads/post/${state.postType}/step/${step}/`);
            if (!response.ok) throw new Error('Failed to load step content');

            const content = await response.text();
            const contentContainer = document.querySelector('#post-content');
            if (contentContainer) {
                // Add fade out effect
                contentContainer.style.opacity = '0';

                setTimeout(() => {
                    contentContainer.innerHTML = content;
                    // Add fade in effect
                    contentContainer.style.opacity = '1';
                }, 300);
            }
        } catch (error) {
            console.error('Error loading step content:', error);
            // Show error message
            const errorContainer = document.querySelector('#post-content');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load content. Please try again.
                    </div>
                `;
            }
        }
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function (e) {
        const url = new URL(window.location.href);
        const step = parseInt(url.searchParams.get('step')) || 1;

        // Update state
        state.currentStep = step;

        // Update progress bar
        const progress = new PostProgress(step, 5);

        // Load content
        loadStepContent(step);
    });
</script>
{% endblock %}